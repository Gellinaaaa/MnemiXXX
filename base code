from telebot import TeleBot
from telebot import types
import json
import os
import random
import time
from datetime import datetime, timedelta
import threading

user_data = {}

def get_user_data(chat_id):
    if chat_id not in user_data:
        user_data[chat_id] = {"blocks": {}}
        print(f"–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {chat_id}.")  # –û—Ç–ª–∞–¥–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    return user_data[chat_id]

FILE_PATH = "blocks.json"

def load_data():
    if os.path.exists(FILE_PATH):
        with open(FILE_PATH, "r", encoding="utf-8") as f:
            return json.load(f)
    return {}

blocks = load_data()

def save_data():
    with open(FILE_PATH, "w", encoding="utf-8") as f:
        json.dump(blocks, f, ensure_ascii=False, indent=4)

token = "7902434008:AAF69cCpY0_k7OHNSKKYFe3k7t9EdExe9go"
bot = TeleBot(token)

@bot.message_handler(commands=['start'])
def start_message(message):

    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    btn1 = types.KeyboardButton("–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –±–ª–æ–∫")
    btn2 = types.KeyboardButton("–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –±–ª–æ–∫–∏")
    btn3 = types.KeyboardButton("–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Å–≤—è–∑–∫—É")
    btn4 = types.KeyboardButton("–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø–∞–º—è—Ç–∏")
    btn5 = types.KeyboardButton("–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?")
    btn6 = types.KeyboardButton("–ù–∞–ø–æ–º–∏–Ω–∞–ª–∫–∏")
    btn7 = types.KeyboardButton("–£–¥–∞–ª–∏—Ç—å –±–ª–æ–∫")
    btn8 = types.KeyboardButton("–£–¥–∞–ª–∏—Ç—å —Å–≤—è–∑–∫—É")
    markup.add(btn1, btn2, btn3, btn4, btn5, btn6, btn7, btn8)
    bot.send_message(message.chat.id, text= "–í—ã –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é.", reply_markup=markup)

@bot.message_handler(content_types=['text'])
def func(message):
    if(message.text == "–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?"):
        bot.send_message(message.chat.id, text="–≠—Ç–æ—Ç —Ç–µ–ª–µ–≥—Ä–∞–º–º-–±–æ—Ç –∑–∞—Ç–æ—á–µ–Ω –ø–æ–¥ –ø–æ–º–æ—â—å —Å –≤—ã—É—á–∏–≤–∞–Ω–∏–µ–º –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–≤—è–∑–æ–∫. –ù–∞–ø—Ä–∏–º–µ—Ä, —Å—Ç—Ä–∞–Ω—ã –∏ –∏—Ö —Å—Ç–æ–ª–∏—Ü—ã, —Å–ª–æ–≤–æ –∏ –µ–≥–æ –ø–µ—Ä–µ–≤–æ–¥,"
                                               "—Å–æ–±—ã—Ç–∏–µ –∏ –¥–∞—Ç–∞ —ç—Ç–æ–≥–æ —Å–æ–±—ã—Ç–∏—è. –î–ª—è —É–¥–æ–±—Å—Ç–≤–∞, —Ä–∞–∑–¥–µ–ª—è–π—Ç–µ —Å–≤—è–∑–∫–∏ –Ω–∞ –±–ª–æ–∫–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –±–ª–æ–∫–µ <–ø–µ—Ä–µ–≤–æ–¥> –ø—É—Å—Ç—å –æ–±–∏—Ç–∞—é—Ç "
                                               "–ø–∞—Ä—ã —Å–ª–æ–≤–æ-–ø–µ—Ä–µ–≤–æ–¥. –ï—Å–ª–∏ –µ—Å—Ç—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Å –∑–∞—É—á–∏–≤–∞–Ω–∏–µ–º, –¥–æ–±–∞–≤—å—Ç–µ —Å–µ–±–µ –≤–º–µ—Å—Ç–µ —Å–æ —Å–≤—è–∑–∫–æ–π –ø–æ–¥—Å–∫–∞–∑–∫—É. –í—ã —Å–∞–º–∏ –≤—ã–±–∏—Ä–∞–µ—Ç–µ, "
                                               "–∫–∞–∫–æ–π –±–ª–æ–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å."
                                               "–¢–∞–∫–∂–µ –≤ –º–µ–Ω—é –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞ <–ù–∞–ø–æ–º–∏–Ω–∞–ª–∫–∏>. –¢–∞–º –í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π —Å —á–∞—Å—Ç—è–º–∏ –í–∞—à–∏—Ö —Å–≤—è–∑–æ–∫."
                                               "–¢–∞–∫, –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è, –±–æ—Ç –±—É–¥–µ—Ç –ø—Ä–∏—Å—ã–ª–∞—Ç—å –í–∞–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è.")
    elif (message.text == "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –±–ª–æ–∫–∏"):
        view_blocks(message)

    elif (message.text == "–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Å–≤—è–∑–∫—É"):
        add_pair_block_selection(message)

    elif (message.text == "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø–∞–º—è—Ç–∏"):
        memory_training(message)

    elif (message.text == "–ù–∞–ø–æ–º–∏–Ω–∞–ª–∫–∏"):
        reminders(message)

    elif(message.text == "–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –±–ª–æ–∫"):
        msg = bot.send_message(message.chat.id, "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –±–ª–æ–∫–∞:")
        bot.register_next_step_handler(msg, add_block)

    elif(message.text == "–£–¥–∞–ª–∏—Ç—å –±–ª–æ–∫"):
        delete_block(message)

    elif(message.text == "–£–¥–∞–ª–∏—Ç—å —Å–≤—è–∑–∫—É"):
        delete_pair(message)


def add_pair_block_selection(message):
    chat_id = message.chat.id
    user_info = get_user_data(chat_id)

    if not user_info["blocks"]:
        bot.send_message(chat_id, "–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –±–ª–æ–∫.")
        start_message(message)
        return

    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ –±–ª–æ–∫–∞
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    for block_name in user_info["blocks"]:
        markup.add(types.KeyboardButton(block_name))

    msg = bot.send_message(chat_id, "–í—ã–±–µ—Ä–∏—Ç–µ –±–ª–æ–∫, –≤ –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å —Å–≤—è–∑–∫—É:", reply_markup=markup)
    bot.register_next_step_handler(msg, add_pair_first)


def add_pair_first(message):
    chat_id = message.chat.id
    user_info = get_user_data(chat_id)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –±–ª–æ–∫
    block_name = message.text
    if block_name not in user_info["blocks"]:
        bot.send_message(chat_id, "–¢–∞–∫–æ–≥–æ –±–ª–æ–∫–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        start_message(message)
        return

    user_info["current_block"] = block_name
    msg = bot.send_message(chat_id, "–í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–≤—É—é —á–∞—Å—Ç—å —Å–≤—è–∑–∫–∏:")
    bot.register_next_step_handler(msg, add_pair_second)


def add_pair_second(message):
    chat_id = message.chat.id
    user_info = get_user_data(chat_id)

    if "current_block" not in user_info:
        bot.send_message(chat_id, "–û—à–∏–±–∫–∞: –±–ª–æ–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω.")
        start_message(message)
        return

    user_info["current_pair"] = {"first": message.text}
    msg = bot.send_message(chat_id, "–í–≤–µ–¥–∏—Ç–µ –≤—Ç–æ—Ä—É—é —á–∞—Å—Ç—å —Å–≤—è–∑–∫–∏:")
    bot.register_next_step_handler(msg, add_pair_hint)


def add_pair_hint(message):
    chat_id = message.chat.id
    user_info = get_user_data(chat_id)

    if "current_pair" not in user_info:
        bot.send_message(chat_id, "–û—à–∏–±–∫–∞: –ø–µ—Ä–≤–∞—è —á–∞—Å—Ç—å —Å–≤—è–∑–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        start_message(message)
        return

    user_info["current_pair"]["second"] = message.text
    msg = bot.send_message(chat_id, "–í–≤–µ–¥–∏—Ç–µ –ø–æ–¥—Å–∫–∞–∑–∫—É –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ '–Ω–µ—Ç':")
    bot.register_next_step_handler(msg, save_pair)


def save_pair(message):
    chat_id = message.chat.id
    user_info = get_user_data(chat_id)

    hint = message.text if message.text.lower() != "–Ω–µ—Ç" else None
    pair = user_info.pop("current_pair", None)

    if not pair:
        bot.send_message(chat_id, "–û—à–∏–±–∫–∞: —Å–≤—è–∑–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        start_message(message)
        return

    block_name = user_info["current_block"]
    user_info["blocks"][block_name]["pairs"].append({
        "first": pair["first"],
        "second": pair["second"],
        "hint": hint
    })
    bot.send_message(chat_id, f"–°–≤—è–∑–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –±–ª–æ–∫ '{block_name}'!")
    start_message(message)  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é


def add_block(message):
    chat_id = message.chat.id
    user_info = get_user_data(chat_id)  # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    block_name = message.text
    if block_name in user_info["blocks"]:
        bot.send_message(chat_id, "–ë–ª–æ–∫ —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")
    else:
        user_info["blocks"][block_name] = {"pairs": []}
        bot.send_message(chat_id, f"–ë–ª–æ–∫ '{block_name}' –¥–æ–±–∞–≤–ª–µ–Ω!")
    start_message(message)  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é


def memory_training(message):
    chat_id = message.chat.id
    user_info = get_user_data(chat_id)

    if not user_info["blocks"]:
        bot.send_message(chat_id, "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±–ª–æ–∫–æ–≤ –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.")
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å—Ç—å –ª–∏ –≤ –±–ª–æ–∫–∞—Ö —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ —Å–≤—è–∑–∫–∞
    available_blocks = {name: data for name, data in user_info["blocks"].items() if data["pairs"]}
    if not available_blocks:
        bot.send_message(chat_id, "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±–ª–æ–∫–æ–≤ –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.")
        return

    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ –±–ª–æ–∫–∞
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    for block_name in available_blocks:
        markup.add(types.KeyboardButton(block_name))

    msg = bot.send_message(chat_id, "–í—ã–±–µ—Ä–∏—Ç–µ –±–ª–æ–∫ –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:", reply_markup=markup)
    bot.register_next_step_handler(msg, start_training, available_blocks)


def start_training(message, available_blocks):
    chat_id = message.chat.id
    block_name = message.text

    if block_name not in available_blocks:
        bot.send_message(chat_id, "–û—à–∏–±–∫–∞: –≤—ã–±—Ä–∞–Ω–Ω—ã–π –±–ª–æ–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.")
        return

    # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–≤—è–∑–æ–∫ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –±–ª–æ–∫–∞
    pairs = available_blocks[block_name]["pairs"]
    if not pairs:
        bot.send_message(chat_id, "–í —ç—Ç–æ–º –±–ª–æ–∫–µ –Ω–µ—Ç —Å–≤—è–∑–æ–∫ –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.")
        return

    # –ù–∞—á–∞–ª–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
    user_data[chat_id]["current_training"] = {
        "block_name": block_name,
        "pairs": pairs,
        "index": 0
    }
    send_training_question(chat_id)


def send_training_question(chat_id):
    training = user_data[chat_id]["current_training"]
    pairs = training["pairs"]
    index = training["index"]

    if index >= len(pairs):
        bot.send_message(chat_id, "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
        del user_data[chat_id]["current_training"]
        return

    pair = pairs[index]
    question = pair["first"]
    hint = pair["hint"]

    msg_text = f"–ß—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç: {question}?"
    if hint:
        msg_text += f" (–ü–æ–¥—Å–∫–∞–∑–∫–∞: {hint})"

    bot.send_message(chat_id, msg_text)
    bot.register_next_step_handler_by_chat_id(chat_id, check_training_answer)


def check_training_answer(message):
    chat_id = message.chat.id
    training = user_data[chat_id]["current_training"]
    pairs = training["pairs"]
    index = training["index"]

    pair = pairs[index]
    correct_answer = pair["second"]

    if message.text.strip().lower() == correct_answer.lower():
        bot.send_message(chat_id, "–í–µ—Ä–Ω–æ!")
    else:
        bot.send_message(chat_id, f"–ù–µ–≤–µ—Ä–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: {correct_answer}")

    # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É
    user_data[chat_id]["current_training"]["index"] += 1
    send_training_question(chat_id)
    start_message(message)  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

def view_blocks(message):
    chat_id = message.chat.id
    user_info = get_user_data(chat_id)
    blocks = user_info["blocks"]

    if not blocks:
        bot.send_message(chat_id, "–£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤.")
        return

    response = "–í–∞—à–∏ –±–ª–æ–∫–∏ –∏ –∏—Ö —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ:\n"
    for block_name, block_data in blocks.items():
        response += f"\nüì¶ –ë–ª–æ–∫: *{block_name}*\n"
        if not block_data["pairs"]:
            response += "  –ü—É—Å—Ç–æ\n"
        else:
            for i, pair in enumerate(block_data["pairs"], start=1):
                first = pair["first"]
                second = pair["second"]
                hint = pair.get("hint", "–±–µ–∑ –ø–æ–¥—Å–∫–∞–∑–∫–∏")
                response += f"  {i}. {first} - {second} (–ø–æ–¥—Å–∫–∞–∑–∫–∞: {hint})\n"

    bot.send_message(chat_id, response, parse_mode="Markdown")

def delete_pair(message):
    chat_id = message.chat.id
    user_info = get_user_data(chat_id)

    if not user_info["blocks"]:
        bot.send_message(chat_id, "–£ –≤–∞—Å –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤ —Å —Å–≤—è–∑–∫–∞–º–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.")
        return

    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ –±–ª–æ–∫–∞
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    for block_name in user_info["blocks"]:
        markup.add(types.KeyboardButton(block_name))

    msg = bot.send_message(chat_id, "–í—ã–±–µ—Ä–∏—Ç–µ –±–ª–æ–∫, –≤ –∫–æ—Ç–æ—Ä–æ–º —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–≤—è–∑–∫—É:", reply_markup=markup)
    bot.register_next_step_handler(msg, select_pair_for_deletion)

def select_pair_for_deletion(message):
    chat_id = message.chat.id
    user_info = get_user_data(chat_id)

    block_name = message.text
    if block_name not in user_info["blocks"]:
        bot.send_message(chat_id, "–¢–∞–∫–æ–≥–æ –±–ª–æ–∫–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        start_message(message)
        return

    # –ï—Å–ª–∏ –≤ –±–ª–æ–∫–µ –Ω–µ—Ç —Å–≤—è–∑–æ–∫
    if not user_info["blocks"][block_name]["pairs"]:
        bot.send_message(chat_id, f"–í –±–ª–æ–∫–µ '{block_name}' –Ω–µ—Ç —Å–≤—è–∑–æ–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.")
        start_message(message)
        return

    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ —Å–≤—è–∑–æ–∫
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    for i, pair in enumerate(user_info["blocks"][block_name]["pairs"], 1):
        markup.add(types.KeyboardButton(f"{i}. {pair['first']} - {pair['second']}"))

    msg = bot.send_message(chat_id, "–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤—è–∑–∫—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:", reply_markup=markup)
    bot.register_next_step_handler(msg, confirm_delete_pair, block_name)

def confirm_delete_pair(message, block_name):
    chat_id = message.chat.id
    user_info = get_user_data(chat_id)

    try:
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω–¥–µ–∫—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å–≤—è–∑–∫–∏
        pair_index = int(message.text.split('.')[0]) - 1
    except ValueError:
        bot.send_message(chat_id, "–û—à–∏–±–∫–∞: –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç.")
        start_message(message)
        return

    if pair_index < 0 or pair_index >= len(user_info["blocks"][block_name]["pairs"]):
        bot.send_message(chat_id, "–û—à–∏–±–∫–∞: –≤—ã–±—Ä–∞–Ω–Ω–∞—è —Å–≤—è–∑–∫–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")
        start_message(message)
        return

    # –£–¥–∞–ª–µ–Ω–∏–µ —Å–≤—è–∑–∫–∏
    del user_info["blocks"][block_name]["pairs"][pair_index]
    bot.send_message(chat_id, f"–°–≤—è–∑–∫–∞ –∏–∑ –±–ª–æ–∫–∞ '{block_name}' —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞.")
    start_message(message)  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

def delete_block(message):
    chat_id = message.chat.id
    user_info = get_user_data(chat_id)

    if not user_info["blocks"]:
        bot.send_message(chat_id, "–£ –≤–∞—Å –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.")
        return

    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ –±–ª–æ–∫–∞
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    for block_name in user_info["blocks"]:
        markup.add(types.KeyboardButton(block_name))

    msg = bot.send_message(chat_id, "–í—ã–±–µ—Ä–∏—Ç–µ –±–ª–æ–∫, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å:", reply_markup=markup)
    bot.register_next_step_handler(msg, confirm_delete_block)

def confirm_delete_block(message):
    chat_id = message.chat.id
    user_info = get_user_data(chat_id)

    block_name = message.text
    if block_name not in user_info["blocks"]:
        bot.send_message(chat_id, "–¢–∞–∫–æ–≥–æ –±–ª–æ–∫–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        start_message(message)
        return

    # –£–¥–∞–ª–µ–Ω–∏–µ –±–ª–æ–∫–∞
    del user_info["blocks"][block_name]
    bot.send_message(chat_id, f"–ë–ª–æ–∫ '{block_name}' —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω.")
    start_message(message)  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é


def reminders(message):
    chat_id = message.chat.id
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    markup.add("–†–∞–∑ –≤ 3 —á–∞—Å–∞", "–†–∞–∑ –≤ 6 —á–∞—Å–æ–≤", "–†–∞–∑ –≤ –¥–µ–Ω—å", "–ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å")

    msg = bot.send_message(chat_id, "–ö–∞–∫ —á–∞—Å—Ç–æ –≤–∞–º –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è?", reply_markup=markup)
    bot.register_next_step_handler(msg, set_reminder_frequency)

def set_reminder_frequency(message):
    chat_id = message.chat.id
    user_info = get_user_data(chat_id)

    frequency = message.text

    if frequency == "–†–∞–∑ –≤ 3 —á–∞—Å–∞":
        user_info["reminder_frequency"] = 3
    elif frequency == "–†–∞–∑ –≤ 6 —á–∞—Å–æ–≤":
        user_info["reminder_frequency"] = 6
    elif frequency == "–†–∞–∑ –≤ –¥–µ–Ω—å":
        user_info["reminder_frequency"] = 24
    elif frequency == "–ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å":
        user_info["reminder_frequency"] = 0
    else:
        bot.send_message(chat_id, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≤—ã–±–æ—Ä. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.")
        reminders(message)
        return

    bot.send_message(chat_id, f"–í—ã –≤—ã–±—Ä–∞–ª–∏: {frequency}. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –±—É–¥—É—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã.")
    start_message(message)  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

def send_random_pair(chat_id):
    user_info = get_user_data(chat_id)

    if not user_info["blocks"]:
        bot.send_message(chat_id, "–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±–ª–æ–∫–æ–≤ –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π.")
        return

    # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –±–ª–æ–∫
    block_name = random.choice(list(user_info["blocks"].keys()))
    block = user_info["blocks"][block_name]

    if not block["pairs"]:
        bot.send_message(chat_id, f"–í –±–ª–æ–∫–µ '{block_name}' –Ω–µ—Ç —Å–≤—è–∑–æ–∫ –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è.")
        return

    # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Å–≤—è–∑–∫—É –∏–∑ –±–ª–æ–∫–∞
    pair = random.choice(block["pairs"])
    first_part = pair["first"]

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—É—é —á–∞—Å—Ç—å —Å–≤—è–∑–∫–∏
    msg = bot.send_message(chat_id, f"–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: {first_part}")

    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ –¥–ª—è –≤–≤–æ–¥–∞ –≤—Ç–æ—Ä–æ–π —á–∞—Å—Ç–∏
    bot.register_next_step_handler(msg, check_second_part, pair, chat_id)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–≤–µ–¥–µ–Ω–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤—Ç–æ—Ä–æ–π —á–∞—Å—Ç–∏
def check_second_part(message, pair, chat_id):
    user_answer = message.text.strip()
    correct_answer = pair["second"].strip()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞
    if user_answer.lower() == correct_answer.lower():
        bot.send_message(chat_id, "–ü—Ä–∞–≤–∏–ª—å–Ω–æ! –ú–æ–ª–æ–¥–µ—Ü!")
    else:
        bot.send_message(chat_id, f"–ù–µ —Å–æ–≤—Å–µ–º. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: {correct_answer}")

    # –ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É –º–µ–Ω—é
    start_message(message)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
def schedule_reminders():
    while True:
        current_time = datetime.now()
        for chat_id, user_info in user_data.items():
            if user_info["reminder_frequency"] > 0:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
                last_reminder_time = user_info.get("last_reminder_time", current_time - timedelta(days=1))
                time_diff = current_time - last_reminder_time

                # –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –Ω—É–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤
                if time_diff >= timedelta(hours=user_info["reminder_frequency"]):
                    send_random_pair(chat_id)
                    user_info["last_reminder_time"] = current_time

        time.sleep(60 * 60)  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π —á–∞—Å

# –ó–∞–ø—É—Å–∫ –ø–æ—Ç–æ–∫–∞ –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
reminder_thread = threading.Thread(target=schedule_reminders)
reminder_thread.daemon = True  # –ü–æ—Ç–æ–∫ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã
reminder_thread.start()



bot.polling(none_stop=True)
